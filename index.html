<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>åå¤å±‹ 8 å¤© 7 å¤œ è¦ªå­è‡ªé§•éŠ</title>
    
    <!-- Environment Config Polyfill -->
    <script>
      // æ¨¡æ“¬ Node.js process.env ç’°å¢ƒè®Šæ•¸
      // å®‰å…¨æ€§æç¤ºï¼šè«‹å‹¿å°‡çœŸå¯¦ API Key æäº¤åˆ° GitHub æˆ–å…¬é–‹ç¶²è·¯ã€‚
      // åœ¨æ­£å¼éƒ¨ç½²æ™‚ï¼Œè«‹é€éä¸»æ©Ÿå•† (å¦‚ Vercel/Netlify) çš„ Environment Variables è¨­å®šã€‚
      window.process = window.process || {
        env: {
          API_KEY: 'AIzaSyCLt3Il5AQjRRiv2zNn_H423lpNWaJb7zw' // è«‹åœ¨æ­¤å¡«å…¥æ‚¨çš„ API Key é€²è¡Œæœ¬æ©Ÿæ¸¬è©¦ï¼Œæˆ–é€é CI/CD æ³¨å…¥
        }
      };
    </script>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              ghibli: {
                cream: '#f4f1ea',
                green: '#4a6c48',
                greenLight: '#8da38b',
                orange: '#e89e70',
                brown: '#5c4839',
                blue: '#7da6bd'
              }
            },
            fontFamily: {
              sans: ['"Hiragino Kaku Gothic ProN"', '"Noto Sans TC"', 'sans-serif'],
            }
          }
        }
      }
    </script>

    <!-- React & Babel Setup -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom": "https://esm.sh/react-dom@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.344.0",
        "recharts": "https://esm.sh/recharts@2.12.2?external=react,react-dom",
        "@google/genai": "https://esm.sh/@google/genai"
      }
    }
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
      body {
        background-color: #f4f1ea;
        color: #5c4839;
        -webkit-font-smoothing: antialiased;
        padding-bottom: 100px; /* Space for bottom nav */
      }
      .no-scrollbar::-webkit-scrollbar { display: none; }
      .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
      
      @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
      }
      .animate-fade-in {
        animation: fadeIn 0.5s ease-out forwards;
      }
      .markdown-body ul { list-style-type: disc; margin-left: 1.5em; margin-bottom: 1em; }
      .markdown-body strong { color: #4a6c48; }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- Main Application Logic -->
    <script type="text/babel" data-type="module">
      import React, { useState, useEffect } from 'react';
      import { createRoot } from 'react-dom/client';
      import { GoogleGenAI } from "@google/genai";
      import { 
        Sun, Cloud, Snowflake, CloudRain, CloudLightning, CloudFog,
        MapPin, Utensils, AlertCircle, Plane, Bed, Wallet, 
        ChevronLeft, Calendar, Info, Navigation, ArrowRight,
        ShoppingBag, Footprints, Store, Ticket, Table, TrainFront, Map,
        CheckCircle, XCircle, Clock, Banknote, ClipboardCheck,
        ArrowRightLeft, RefreshCw, Coins, Calculator, ExternalLink,
        Thermometer, Sparkles, Loader2, MessageCircle, Receipt, Trash2, Plus
      } from 'lucide-react';
      // Recharts import removed as per user request to delete budget chart

      // --- DATA ---

      const ITINERARY_DATA = [
        {
          id: 1,
          dateLabel: "D1",
          title: "æŠµé”åå¤å±‹ãƒ»å…¥ä½æ—¥",
          weather: { temp: "10Â°C / 4Â°C", condition: "å¤šé›²æ™‚æ™´", icon: 'cloud' },
          highlights: ["ä¸­éƒ¨åœ‹éš›æ©Ÿå ´", "åéµ ÂµSKY", "å‘³ä»™æ‹‰éºµ", "ä¾¿åˆ©å•†åº—å‚™æ¡ˆ"],
          schedule: [
            { time: "17:15", title: "å°ç£ â†’ åå¤å±‹", description: "ä¸­éƒ¨åœ‹éš›æ©Ÿå ´ (NGO)", important: "ç¢ºä¿å¨ƒå¨ƒè»Šã€è¡Œææ¨™ç±¤", type: "transport" },
            { time: "20:50", title: "æŠµé” & å…¥å¢ƒ", description: "å¤œé–“èˆªç­äººæ½®ä¸å¤šï¼Œé€šé—œç´„ 30-40 åˆ†é˜", type: "transport" },
            { time: "21:40", title: "åéµ ÂµSKY è³¼ç¥¨", description: "å»ºè­°ç¾å ´è²·ç¥¨ (çª—å£å¯è²·å…’ç«¥åº§ä½ç¥¨)", important: "å»ºè­°å»äººå·¥æ«ƒå°", type: "transport" },
            { time: "22:00", title: "æ­ ÂµSKY â†’ åå¤å±‹ç«™", description: "ç›´é” 28 åˆ†é˜ (é©åˆå¸¶å°å­©ä¸æ›è»Š)", important: "è‹¥å­©å­æœƒç¡è‘—ï¼Œå»ºè­°è²·å…’ç«¥æŒ‡å®šå¸­", type: "transport" },
            { time: "22:45", title: "é£¯åº— Check-in", description: "Daiwa Roynet æ–°å¹¹ç·šå£ (æ­¥è¡Œ3-5åˆ†é˜)", important: "å¯è«‹é£¯åº—æä¾›å…’ç«¥å‚™å“", type: "visit", navLink: "Daiwa Roynet Hotel Nagoya Taiko dori Side" },
          ],
          food: [
            { name: "å‘³ä»™ (ä¸»é¸)", type: "å°å¼æ‹‰éºµ", price: "Â¥1,000~", features: ["å¯é»ä¸è¾£", "ç‚’é£¯", "é’èœ"], isPrimary: true, navLink: "å‘³ä»™ åå¤å±‹é§…å‰åº—" },
            { name: "ä¸–ç•Œã®å±±ã¡ã‚ƒã‚“", type: "æ›¿ä»£æ–¹æ¡ˆ", price: "Â¥1,200~", features: ["æ‹›ç‰Œé›ç¿…", "ä¸²ç‡’"], isPrimary: false, navLink: "ä¸–ç•Œçš„å±±ã¡ã‚ƒã‚“ åé§…åº—" },
            { name: "ä¾¿åˆ©å•†åº— (å‚™æ¡ˆ)", type: "FamilyMart/Lawson", price: "å®µå¤œ", features: ["é£¯ç³°", "ç‚¸é›ä¸²", "ç”œé»"], isPrimary: false, navLink: "åå¤å±‹é§… æ–°å¹¹ç·šå£ ä¾¿åˆ©å•†åº—" },
          ],
          tips: ["ÂµSKY: è‹¥å­©å­æœƒç¡è‘—ï¼Œå»ºè­°è²·å…’ç«¥æŒ‡å®šå¸­ã€‚", "è‹¥å°å­©å¤ªç´¯ï¼Œå»ºè­°ç›´æ¥åƒä¾¿åˆ©å•†åº—+æ—©ä¼‘æ¯ã€‚", "é£¯åº—ä½æ–¼æ–°å¹¹ç·šå£(å¤ªé–¤é€šå£)ï¼Œå‡ºç«™æ­¥è¡Œç´„ 4 åˆ†é˜ã€‚"]
        },
        {
          id: 2,
          dateLabel: "D2",
          title: "æ¨‚é«˜æ¨‚åœ’ LEGOLAND",
          weather: { temp: "12Â°C / 5Â°C", condition: "æ™´æœ—", icon: 'sun' },
          highlights: ["LEGO NINJAGO", "Submarine Adventure", "Miniland"],
          schedule: [
            { time: "09:30", title: "å…¥åœ’", description: "æ­ä¹˜ã‚ãŠãªã¿ç·šè‡³é‡‘åŸãµé ­ç«™ (å»ºè­°è²·ä¸€æ—¥åˆ¸)", type: "visit" },
            { time: "09:30-11:30", title: "ç¬¬ä¸€è¼ª (äººæ°£æœ€é«˜)", description: "Ninjago, Submarine, Lost Kingdom", type: "visit" },
            { time: "11:30-12:00", title: "ä¼‘æ¯ & æ‹ç…§", description: "MiniLand (å®¤å…§æ¶¼çˆ½)", type: "rest" },
            { time: "13:00-15:30", title: "ç¬¬äºŒè¼ª (å½ˆæ€§)", description: "Driving School (4æ­²æ„›), Duplo Play", type: "visit" },
            { time: "16:00-17:00", title: "ç¬¬ä¸‰è¼ª (è¼•é¬†)", description: "Pirate Splash Battle, Build & Test", type: "visit" },
            { time: "17:00", title: "é›¢åœ’", description: "è²·å°ç‰©+æ‹ç…§", type: "transport" },
          ],
          food: [
            { name: "Brick House Burger", type: "åˆé¤(é€ å‹)", price: "Â¥1,200~", features: ["æ¨‚é«˜é€ å‹æ¼¢å ¡"], isPrimary: true },
            { name: "Coral Reef Pizza", type: "åˆé¤(åƒåˆ°é£½)", price: "Â¥1,800~", features: ["ç¾©å¤§åˆ©éºµ/æŠ«è–©", "å…’ç«¥æœ€æ„›"], isPrimary: false },
            { name: "Chicken Diner", type: "åˆé¤(é€Ÿé£Ÿ)", price: "Â¥1,000~", features: ["ç‚¸é›", "å‡ºé¤æœ€å¿«"], isPrimary: false },
            { name: "å¤©ã‚€ã™ åƒå£½", type: "æ™šé¤(A:çœæ™‚)", price: "Â¥800~", features: ["ç‚¸è¦é£¯ç³°", "é«˜å³¶å±‹B1å¤–å¸¶", "å­©å­å¯åƒ"], isPrimary: true, navLink: "JR Takashimaya Nagoya" },
            { name: "å‘³ä»™ / å±±ã¡ã‚ƒã‚“", type: "æ™šé¤(C:åç‰©)", price: "Â¥1,500~", features: ["ä¸è¾£æ‹‰éºµ", "æ‹›ç‰Œé›ç¿…"], isPrimary: false, navLink: "ä¸–ç•Œçš„å±±ã¡ã‚ƒã‚“ åé§…åº—" },
          ],
          tips: ["æ¨‚åœ’ä¸é©åˆæ¨è»Šé€²å ´ (å…¥å£å¯åœæ”¾)ã€‚", "MiniLand æ˜¯æœ€ä½³å®¤å…§ä¼‘æ¯ç«™ã€‚", "ä¸‹é›¨è«‹ç›´æ¥å» Duplo Play æˆ– Police Stationã€‚"]
        },
        {
          id: 3,
          dateLabel: "D3",
          title: "ç™½å·é„‰ãƒ»é£›é¨¨é«˜å±± (å·´å£«åœ˜)",
          weather: { temp: "5Â°C / -3Â°C", condition: "é›ªåœ° / æ™´", icon: 'snow' },
          highlights: ["é«˜å±±è€è¡—", "é£›é©’ç‰›å£½å¸", "åˆæŒæ‘"],
          schedule: [
            { time: "08:45", title: "é›†åˆ", description: "åéµå·´å£«ä¸­å¿ƒãƒ»å¤ªé–¤é€šå£ (éŠ€æ™‚è¨ˆ)", important: "æº–æ™‚é›†åˆ!", type: "transport" },
            { time: "09:00", title: "å‡ºç™¼", description: "å‰å¾€é«˜å±± (è»Šç¨‹ç´„ 2.5 å°æ™‚)", type: "transport" },
            { time: "11:30-13:30", title: "é«˜å±±è€è¡—", description: "ä¸Šä¸‰ä¹‹ç”ºæ•£æ­¥ã€åˆé¤", type: "visit" },
            { time: "14:30-16:00", title: "ç™½å·é„‰åˆæŒæ‘", description: "æ²³å²¸æ‹ç…§ã€æ°‘å®¶åœ’ã€å’Œç”°å®¶", important: "ä¸å»ºè­°å»åŸå±±å±•æœ›å°(è·¯æ»‘)", type: "visit" },
            { time: "16:30", title: "è¿”ç¨‹", description: "é è¨ˆ 19:00 æŠµé”åå¤å±‹", type: "transport" },
          ],
          food: [
            { name: "é£›é¨¨ç‰›é£¯ åŒ å®¶", type: "åˆé¤(ä¸»æ¨)", price: "Â¥1,800~", features: ["é£›é©’ç‰›ä¸¼", "å‡ºé¤å¿«", "å°å­©å‹å–„"], isPrimary: true, navLink: "Takumiya Takayama" },
            { name: "ä¸¸æ˜ é«˜å±±å®‰å·åº—", type: "åˆé¤(å‚™é¸)", price: "Â¥2,800~", features: ["A5ç‡’è‚‰", "æ’éšŠå€¼å¾—"], isPrimary: false, navLink: "Maruaki Takayama Yasukawa" },
            { name: "é‡‘ä¹ƒã“ã£ã¦ç‰›", type: "å¿…åƒå°åƒ", price: "Â¥1,000", features: ["é£›é©’ç‰›å£½å¸ä¸‰è²«"], isPrimary: false, navLink: "Kotte Ushi" },
            { name: "ã—ã‚‰æ²³", type: "æ™šé¤(ä¸»é¸)", price: "Â¥2,800~", features: ["é°»é­šä¸‰åƒ", "æ¸…çˆ½ä¸è†©"], isPrimary: true, navLink: "Hitsumabushi Shirakawa" },
            { name: "ã²ã¤ã¾ã¶ã—å‚™é•·", type: "æ™šé¤(å‚™é¸)", price: "Â¥3,500~", features: ["å‡ºé¤å¿«", "ç‚­çƒ¤é¦™"], isPrimary: false, navLink: "Hitsumabushi Bincho" },
          ],
          tips: ["å¿…å‚™ï¼šé˜²æ»‘é›ªåœ°é‹(æˆ–é‹å¥—)ã€æš–æš–åŒ…ã€é˜²æ°´æ‰‹å¥—ã€‚", "å°å­©å®¹æ˜“æ»‘å€’ï¼Œæ³¨æ„ç©é›ªèˆ‡æº¶é›ªå‡æ°´ã€‚", "åŸå±±å±•æœ›å°è·¯æ»‘ä¸”å¸¸æ’éšŠï¼Œä¸å»ºè­°å‰å¾€ã€‚"]
        },
        {
          id: 4,
          dateLabel: "D4",
          title: "å‰åœåŠ›å…¬åœ’ä¸€æ—¥éŠ (å®Œæ•´ç‰ˆ)",
          weather: { temp: "10Â°C / 3Â°C", condition: "å¤šé›²", icon: 'cloud' },
          highlights: ["å‰åœåŠ›å¤§å€‰åº«", "é¾è²“éš§é“", "AEON ç©å…·åæ–—åŸ"],
          schedule: [
            { time: "09:30", title: "æŠµé”å…¬åœ’", description: "åœ°éµæ±å±±ç·š â†’ è—¤ãŒä¸˜ â†’ ãƒªãƒ‹ãƒ¢ (ç´„50åˆ†)", important: "å»ºè­°æå‰ 15-30 åˆ†é˜æ’éšŠ", type: "transport" },
            { time: "10:00", title: "å¤§å€‰åº«åƒè§€ (éœ€é ç´„)", description: "é¾è²“éš§é“ (å°å­©æœ€æ„›)ã€é£›è¡Œèˆ¹ã€åå ´é¢å±•", important: "è«‹æº–å‚™å¥½é ç´„ QR Code", type: "visit" },
            { time: "13:00", title: "åˆé¤æ™‚é–“", description: "åœ’å…§å’–å•¡å»³ æˆ– AEON ç¾é£Ÿè¡—", type: "food" },
            { time: "15:00", title: "AEON é•·ä¹…æ‰‹è³¼ç‰©", description: "ç©å…·åæ–—åŸ (è¶…å¤§)ã€è¦ªå­ä¼‘æ¯å€", type: "shopping" },
            { time: "18:00", title: "æ™šé¤", description: "è¿”å›åå¤å±‹å¸‚å€äº«ç”¨é°»é­šé£¯", type: "food" },
          ],
          food: [
            { name: "é¢¨ä¹‹è°· CafÃ©", type: "åœ’å…§ç°¡é¤", price: "Â¥1,200~", features: ["å’–å“©é£¯(å°è¾£)", "ä¸‰æ˜æ²»"], isPrimary: true, navLink: "Ghibli Park" },
            { name: "AEON ç¾é£Ÿè¡—", type: "å‚™é¸", price: "Â¥900~", features: ["ç‚¸é›", "çƒé¾éºµ", "é¸æ“‡å¤š"], isPrimary: false, navLink: "Aeon Mall Nagakute" },
            { name: "ã—ã‚‰æ²³ (æ™šé¤)", type: "é°»é­šä¸‰åƒ", price: "Â¥2,800~", features: ["æ¸…çˆ½ä¸è†©", "å­©å­å‹å–„"], isPrimary: true, navLink: "Hitsumabushi Shirakawa" },
            { name: "ã²ã¤ã¾ã¶ã—å‚™é•·", type: "æ™šé¤å‚™é¸", price: "Â¥3,500~", features: ["å‡ºé¤å¿«", "çœæ™‚"], isPrimary: false, navLink: "Hitsumabushi Bincho" },
          ],
          tips: ["å¤§å€‰åº«ç¦æ­¢æ¨è»Šå…¥é¤¨ (å…¥å£æœ‰å…è²»å¯„æ”¾å€)ã€‚", "å»ºè­°é ç•™ 3-4 å°æ™‚åƒè§€å¤§å€‰åº«ã€‚", "å±•å€å†·æ°£è¼ƒå¼·ï¼Œè«‹æ”œå¸¶è–„å¤–å¥—ã€‚", "é–€ç¥¨å»ºè­°ï¼šå¤§å€‰åº«å–®é¤¨ç¥¨ (Standard)ï¼Œå…¨å®¤å…§ä¸æ€•é›¨ã€‚"]
        },
        {
          id: 5,
          dateLabel: "D5",
          title: "Outlet & åèŠ±ä¹‹é‡Œ",
          weather: { temp: "11Â°C / 2Â°C", condition: "æœ‰é¢¨/æ™´", icon: 'sun' },
          highlights: ["ä¸‰äº• Outlet", "å…‰ä¹‹éš§é“", "æ°´ä¸Šç‡ˆå…‰ç§€"],
          schedule: [
            { time: "09:10", title: "å·´å£«å‡ºç™¼", description: "åéµå·´å£«ä¸­å¿ƒ (ä½¿ç”¨ã€Œã‚†ã£ãŸã‚Šãƒ‘ãƒƒã‚¯ã€å¥—ç¥¨)", important: "æˆäººÂ¥3,700/å…’ç«¥Â¥2,100 (å«é‡‘åˆ¸)", type: "transport" },
            { time: "10:10", title: "Outlet è³¼ç‰©", description: "å‹•ç·šï¼šNorth (ç²¾å“/é‹å‹•) â†’ South (é›œè²¨)", type: "shopping" },
            { time: "12:00", title: "åˆé¤", description: "ä¸­å¤®ä¼‘æ¯å€ç¾é£Ÿè¡—", type: "food" },
            { time: "16:00", title: "å‰å¾€åèŠ±ä¹‹é‡Œ", description: "æ­ä¹˜æ¥é§å·´å£«", type: "transport" },
            { time: "17:00", title: "é»ç‡ˆè³èŠ±", description: "æº«å®¤(ä¼‘æ¯) â†’ å…‰ä¹‹éš§é“ â†’ å¤§è‰åªä¸»ç§€", important: "é»ç‡ˆç¬é–“æœ€ç¾ (ç´„17:00)", type: "visit" },
            { time: "19:00", title: "æ™šé¤/è¿”å›", description: "å›åå¤å±‹å¸‚å€åƒé›ç¿…/æ‹‰éºµ", type: "food" },
          ],
          food: [
            { name: "VANSAN (Outlet)", type: "ç¾©å¼æ–™ç†", price: "Â¥1,500~", features: ["è¦ªå­å‹å–„", "å…è²»å…’ç«¥é¤å…·"], isPrimary: true, navLink: "Italian Kitchen VANSAN Jazz Dream Nagashima" },
            { name: "çŸ¢å ´ã¨ã‚“ (Outlet)", type: "å‘³å™Œè±¬æ’", price: "Â¥1,500~", features: ["åå¤å±‹åç‰©", "å¯é¸ä¸è¾£"], isPrimary: false, navLink: "Yabaton Jazz Dream Nagashima" },
            { name: "ã¾ã‚‹ã¯é£Ÿå ‚ (Outlet)", type: "ç‚¸è¦å®šé£Ÿ", price: "Â¥1,800~", features: ["å·¨å¤§ç‚¸è¦", "åç‰©"], isPrimary: false, navLink: "Maruha Shokudo Jazz Dream" },
            { name: "ä¸–ç•Œã®å±±ã¡ã‚ƒã‚“", type: "æ™šé¤(åç«™)", price: "Â¥2,000~", features: ["æ–¹ä¾¿", "è¦ªå­å¯é£Ÿ"], isPrimary: false, navLink: "ä¸–ç•Œçš„å±±ã¡ã‚ƒã‚“ åé§…åº—" },
          ],
          tips: ["å¥—ç¥¨ã€Œã‚†ã£ãŸã‚Šãƒ‘ãƒƒã‚¯ã€æœ€åˆ’ç®— (å«äº¤é€š+é–€ç¥¨+Â¥1000é‡‘åˆ¸)ã€‚", "æ¨è–¦å“ç‰Œï¼šBeams, United Arrows, Nike, BREEZE(ç«¥è£)ã€‚", "åèŠ±ä¹‹é‡Œå¤œé–“å¾ˆå†·ï¼Œå‹™å¿…ç©¿åšå¤–å¥—ã€åœå·¾ã€å¸¶æš–æš–åŒ…ã€‚", "ã€Œæº«å®¤ã€æ˜¯æœ€ä½³ä¿æš–ä¼‘æ¯é»ã€‚"]
        },
        {
          id: 6,
          dateLabel: "D6",
          title: "ç‰§æ­Œä¹‹é‡Œå†°é›ªæ¨‚åœ’ + æº«æ³‰é«”é©—æ—¥",
          weather: { temp: "4Â°C / -5Â°C", condition: "é™é›ª / æ™´", icon: 'snow' },
          highlights: ["é›ªç›†æˆ²é›ª", "å‹•ç‰©é¤µé£Ÿ", "ç‰§è¯æº«æ³‰"],
          schedule: [
            { time: "08:45", title: "é›†åˆ", description: "åéµå·´å£«ä¸­å¿ƒ (å¤ªé–¤é€šå£ éŠ€æ™‚è¨ˆ)", important: "æº–æ™‚é›†åˆ", type: "transport" },
            { time: "09:10", title: "å‡ºç™¼", description: "å‰å¾€ç‰§æ­Œä¹‹é‡Œ (è»Šç¨‹ç´„ 1.5 å°æ™‚)", type: "transport" },
            { time: "10:30-15:00", title: "å†°é›ªæ¨‚åœ’", description: "å‹•ç·šï¼šå…¥å£ â†’ é›ªç›†å€ â†’ å †é›ªäºº â†’ å‹•ç‰©å€", important: "å¿…å‚™é˜²æ°´æ‰‹å¥—ã€é˜²æ»‘é´ã€å‚™ç”¨è¥ªå­", type: "visit" },
            { time: "15:00-16:30", title: "æº«æ³‰é«”é©—", description: "ç‰§è¯æº«æ³‰ (å®¤å…§+éœ²å¤©)", important: "å…¥æ± å‰è«‹å…ˆæ²–æ¾¡", type: "rest" },
            { time: "17:00", title: "è¿”å›åå¤å±‹", description: "é è¨ˆ 19:00 æŠµé”è§£æ•£", type: "transport" },
          ],
          food: [
            { name: "ãµã‚‹é‡Œäº­ (åœ’å…§)", type: "åˆé¤(è¦ªå­)", price: "Â¥1,500~", features: ["ç‰›å¥¶é‹", "ç”œå‘³å’–å“©"], isPrimary: true, navLink: "Bokka no Sato" },
            { name: "ã¾ãã°ã®é¤¨ (åœ’å…§)", type: "åˆé¤(æ´‹é£Ÿ)", price: "Â¥1,200~", features: ["æ¼¢å ¡æ’", "å‡ºé¤å¿«"], isPrimary: false, navLink: "Bokka no Sato" },
            { name: "ä¸–ç•Œã®å±±ã¡ã‚ƒã‚“", type: "æ™šé¤(åç«™)", price: "Â¥2,000~", features: ["ç‰å­ç‡’", "å‘³å™Œè±¬æ’", "è¿‘é£¯åº—"], isPrimary: true, navLink: "ä¸–ç•Œçš„å±±ã¡ã‚ƒã‚“ åé§…åº—" },
            { name: "å‘³ä»™ (åç«™)", type: "æ™šé¤(æš–èƒƒ)", price: "Â¥1,500~", features: ["ä¸è¾£æ‹‰éºµ"], isPrimary: false, navLink: "å‘³ä»™ åå¤å±‹é§…å‰åº—" },
          ],
          tips: ["å¿…å‚™ï¼šé˜²æ»‘é›ªé´(æˆ–é‹å¥—)ã€é˜²æ°´æ‰‹å¥—ã€å°å­©å‚™ç”¨è¥ªå­ã€‚", "æº«æ³‰åˆºé’éœ€è²¼é®è“‹è²¼ã€‚", "é›ªåœ°åå°„å¼·ï¼Œå»ºè­°é…æˆ´å¢¨é¡ã€‚"]
        },
        {
          id: 7,
          dateLabel: "D7",
          title: "ç§‘å­¸é¤¨ãƒ»å¤§é ˆãƒ»æ©Ÿå ´",
          weather: { temp: "13Â°C / 6Â°C", condition: "æ™´æœ—", icon: 'sun' },
          highlights: ["å…’ç«¥ç§‘å­¸é¤¨", "å¤§é ˆå•†åº—è¡—", "å”å‰è»»å¾·æ¡è²·"],
          schedule: [
            { time: "10:00", title: "åå¤å±‹å¸‚ç§‘å­¸é¤¨", description: "å¿…ç©ï¼š2F å…’ç«¥é¤¨ & 3F æ”¾é›»å¯¦é©—", important: "ä¸­å­¸ç”Ÿä»¥ä¸‹å…è²»", type: "visit", navLink: "Nagoya City Science Museum" },
            { time: "12:30", title: "åˆé¤ (æ¦®å€)", description: "ã‚µã‚¬ãƒŸ æˆ– ã‚³ãƒ¡ãƒ€çˆç²", type: "food" },
            { time: "14:00", title: "å¤§é ˆå•†åº—è¡—", description: "è·¯ç·šï¼šå¤§é ˆè§€éŸ³ç«™(2è™Ÿå‡ºå£) â†’ èµ¤é–€é€š(æ‰­è›‹) â†’ æ–°å¤©åœ°é€š", type: "shopping", navLink: "Osu Shopping District" },
            { time: "15:15", title: "å”å‰è»»å¾·æ¦®æœ¬åº—", description: "1Fé›¶é£Ÿ(éºµåŒ…è¶…äºº)ã€2Fè—¥å¦(çœ¼è—¥æ°´)ã€3Få…’ç«¥(å…¥æµ´çƒ)", type: "shopping", navLink: "Don Quijote Sakae" },
            { time: "17:30", title: "æ™šé¤ & å–è¡Œæ", description: "æ¦®å€æ™šé¤å¾Œï¼Œå›é£¯åº—å–è¡Œæ", important: "å»ºè­° 17:10 å‰å…¥åº—æ™šé¤", type: "food" },
            { time: "20:00", title: "å‰å¾€æ©Ÿå ´", description: "åéµ ÂµSKY â†’ ä¸­éƒ¨åœ‹éš›æ©Ÿå ´", type: "transport" },
            { time: "21:00", title: "å…¥ä½æ©Ÿå ´é£¯åº—", description: "Comfort Hotel Centrair (é€£é€šèˆªå»ˆ)", type: "rest", navLink: "Comfort Hotel Central International Airport" },
          ],
          food: [
            { name: "ã‚µã‚¬ãƒŸ æ „åº—", type: "åˆé¤(å’Œé£Ÿ)", price: "Â¥1,200~", features: ["è•éº¥éºµ", "å…’ç«¥é¤"], isPrimary: true, navLink: "Sagami Sakae" },
            { name: "é‡‘é­šè™ç‡’", type: "å¤§é ˆå°åƒ", price: "Â¥300", features: ["å¯æ„›é¯›é­šç‡’", "å¤–é…¥å…§è»Ÿ"], isPrimary: false, navLink: "Kingyo Tayaki" },
            { name: "ã—ã‚‰æ²³ æ¦®ã‚¬ã‚¹ãƒ“ãƒ«åº—", type: "æ™šé¤(é°»é­š)", price: "Â¥2,800~", features: ["é°»é­šä¸‰åƒ", "æ¸…çˆ½"], isPrimary: true, navLink: "Shirakawa Sakae Gas Building" },
          ],
          tips: ["ç§‘å­¸é¤¨æ¨è»Šå‹å–„ï¼Œä½†å¤§é ˆå•†åº—è¡—äººå¤šè·¯çª„ä¸å»ºè­°å…¨ç¨‹ä½¿ç”¨ã€‚", "Donki æ¡è²·é‡é»ï¼š1F ä¼´æ‰‹ç¦®ã€2F è—¥å¦ã€3F å…’ç«¥ç”¨å“ã€‚", "æ™šé¤å»ºè­° 17:10 å‰å…¥åº—é¿å…æ’éšŠã€‚"]
        },
        {
          id: 8,
          dateLabel: "D8",
          title: "å›ç¨‹æ—¥ (ä¸­éƒ¨åœ‹éš›æ©Ÿå ´ â†’ å°ç£)",
          weather: { temp: "11Â°C / 5Â°C", condition: "å¤šé›²", icon: 'cloud' },
          highlights: ["Comfort Hotel", "è¦ä»™è²ä¹‹é‡Œ", "å…’ç«¥éŠæˆ²å€"],
          schedule: [
            { time: "07:00", title: "é£¯åº—æ—©é¤", description: "Comfort Hotel (06:00é–‹å§‹ä¾›æ‡‰)", important: "å»ºè­° 07:00-08:00 ç”¨é¤", type: "food" },
            { time: "08:00", title: "å‰å¾€èˆªå»ˆ", description: "æ­¥è¡Œ 3 åˆ†é˜ (æœ‰é›¨æ£šç›´é€š)", type: "transport" },
            { time: "09:00", title: "å ±åˆ°æ‰˜é‹", description: "ä¸­éƒ¨åœ‹éš›æ©Ÿå ´ (NGO)", important: "å»ºè­°é ç•™ 1 å°æ™‚ä»¥ä¸Š", type: "transport" },
            { time: "09:50", title: "èµ·é£› (è¿”å›å°ç£)", description: "äºŒæ¨“æœ‰å…’ç«¥éŠæˆ²å€å¯æ”¾é›»", type: "transport" },
            { time: "12:15", title: "æŠµé”å°ç£", description: "ç”œèœœçš„å®¶", type: "transport" },
          ],
          food: [
            { name: "è¦ä»™è²ä¹‹é‡Œ", type: "ä¼´æ‰‹ç¦®", price: "Â¥600~", features: ["è©¦åƒå¤š", "å¿…è²·"], isPrimary: true, navLink: "Ebisenbei No Sato Centrair" },
            { name: "å‚è§’ç¸½æœ¬èˆ–", type: "ä¼´æ‰‹ç¦®", price: "Â¥1,000~", features: ["è¦é¤…ååº—"], isPrimary: false, navLink: "Bankaku Sohonpo Centrair" },
            { name: "æ‰‹ç¾½å…ˆçœŸç©ºåŒ…", type: "ä¼´æ‰‹ç¦®", price: "Â¥1,200~", features: ["é¢¨ä¾†åŠ/å±±ã¡ã‚ƒã‚“", "å¯å¸¶å›åœ‹"], isPrimary: false },
            { name: "æ˜Ÿä¹ƒçˆç²åº—", type: "æ—©é¤/è¼•é£Ÿ", price: "Â¥800~", features: ["åšé¬†é¤…", "ç„—é£¯"], isPrimary: false, navLink: "Hoshino Coffee Centrair" },
          ],
          tips: ["Comfort Hotel è·é›¢èˆªå»ˆåƒ… 3 åˆ†é˜æ­¥è¡Œï¼Œä¸”æœ‰é›¨æ£šã€‚", "é€šé—œå‰å¯å» 2F å…’ç«¥éŠæˆ²å€çŸ­æš«æ”¾é›»ã€‚", "æ‰‹ç¾½å…ˆ(é›ç¿…)è«‹è²·ã€ŒçœŸç©ºåŒ…ã€æ‰èƒ½å¸¶å›å°ç£ã€‚"]
        }
      ];

      const TAIKO_SHOPS = [
        { name: "MaxValu å¤ªé–¤åº—", dist: "12åˆ†", type: "è¶…å¸‚", tag: "24Hãƒ»ç¨®é¡é½Š", note: "æœ€æ¨è–¦", navLink: "MaxValu Taiko" },
        { name: "Sun-Ace é¾œå³¶åº—", dist: "11åˆ†", type: "è¶…å¸‚", tag: "ä¾¿å®œãƒ»åœ¨åœ°", note: "é24H", navLink: "Sun-Ace Kamejima" },
        { name: "Donki åç«™è¥¿åº—", dist: "6åˆ†", type: "ç™¾è²¨", tag: "é›¶é£Ÿè—¥å¦", note: "å¿…é€›", navLink: "Don Quijote Nagoya Station West" },
        { name: "Sugi Drug (ã‚¹ã‚®è–¬å±€)", dist: "5åˆ†", type: "è—¥å¦", tag: "å¥¶ç²‰æ¿•ç´™å·¾", note: "ç”Ÿæ´»ç”¨å“", navLink: "Sugi Drug Nagoya Station West" },
        { name: "æ¾æœ¬æ¸… åå¤å±‹è¥¿å£", dist: "6åˆ†", type: "è—¥å¦", tag: "çˆ†å“å…¨", note: "æ„Ÿå†’è…¸èƒƒè—¥", navLink: "Matsumoto Kiyoshi Nagoya Station West" },
        { name: "AEON é¾œå³¶", dist: "15åˆ†", type: "å•†åŸ", tag: "å…’ç«¥ç©å…·", note: "æœ€å¾Œè£œè²¨", navLink: "Aeon Mall Nagoya Noritake Garden" },
        { name: "7-11 / Lawson", dist: "1-3åˆ†", type: "è¶…å•†", tag: "å¿«é€Ÿè£œçµ¦", note: "", navLink: "Convenience Store near Daiwa Roynet Hotel Nagoya Taiko dori Side" },
      ];

      const TAIKO_ROUTES = [
        { title: "æœ€çœåŠ›è·¯ç·š (D1/D2æ™š)", desc: "é£¯åº— â†’ 7-11/Lawson â†’ å›æˆ¿", tag: "ç´¯ç™±å°ˆç”¨" },
        { title: "è¶…å¸‚æ¡è²·è·¯ç·š (D7æ™š)", desc: "é£¯åº— â†’ Donki â†’ MaxValu", tag: "ä¸€æ¬¡æå®š" },
        { title: "å…’ç«¥ç”¨å“è·¯ç·š", desc: "é£¯åº— â†’ èµ°è·¯è‡³ AEON é¾œå³¶", tag: "å°¿å¸ƒ/ç©å…·" },
      ];

      const DONKI_MUST_BUY = [
        { category: "ğŸ¥‡ã€1ã€‘é›¶é£Ÿ (1F)", items: ["éºµåŒ…è¶…äººé¤…ä¹¾ç›’ (é€ç¦®)", "éºµåŒ…è¶…äººæœå‡æ¯", "ã˜ã‚ƒãŒã‚Šã“ (è–¯æ¢æ¯)", "æ˜æ²»å·§å…‹åŠ›å°ç›’", "æŠ¹èŒ¶å¤¾å¿ƒé¤… (ç‰¹åƒ¹)"] },
        { category: "ğŸ²ã€2ã€‘å³é£Ÿ (1F/2F)", items: ["S&B é‡‘ç‰Œå’–å“© (ç”˜å£)", "æ—¥æ¸…çƒé¾éºµæ¯ (æº«å’Œ)", "å‘³å™Œæ¹¯çµ„åˆåŒ… (10å…¥)"] },
        { category: "ğŸ’Šã€3ã€‘è—¥å¦ (2F)", items: ["Rohto çœ¼è—¥æ°´ V5", "Rohto é‡‘è‰²çœ¼è—¥æ°´", "PAIR ç¥›ç—˜è†", "AD/Muhi æ­¢ç™¢ä¹³æ¶²", "å°å­©é€€ç†±è²¼ (å¿…è²·)"] },
        { category: "ğŸ§¸ã€4ã€‘å…’ç«¥ (3F)", items: ["å…¥æµ´çƒ (é©šå–œç©å…·)", "éºµåŒ…è¶…äººç‰™åˆ· 3å…¥çµ„"] }
      ];

      const TRANSPORT_TICKETS = [
        { d: "D1", route: "åéµ ÂµSKY", ticket: "æŒ‡å®šå¸­åˆ¸", price: "Â¥1250", color: "bg-red-100 text-red-800", tip: "è‹¥ä½”ä½éœ€è³¼å…’ç«¥ç¥¨ (ä¸ä½”ä½å…è²»)ã€‚\nå»ºè­°æŠµé”å¾Œå»äººå·¥æ«ƒå°è³¼ç¥¨ï¼Œå¯é †ä¾¿åŠƒä½å›ç¨‹ã€‚" },
        { d: "D2", route: "ã‚ãŠãªã¿ç·š", ticket: "ä¸€æ—¥åˆ¸", price: "Â¥870", color: "bg-blue-100 text-blue-800", tip: "æ¨‚åœ’å…¥å£å¯åœæ¨è»Š (ä¸å¯å…¥åœ’)ã€‚\nä¸€æ—¥åˆ¸åªè¦ä¾†å›ä¸€è¶Ÿ+ä¸­é€”ä¸‹è»Šä¸€æ¬¡å°±åˆ’ç®—ã€‚" },
        { d: "D3", route: "KKday å·´å£«", ticket: "åœ˜è²»åŒ…å«", price: "-", color: "bg-orange-100 text-orange-800", tip: "å¹¼ç«¥å«åœ¨åœ˜è²»ä¸­ (æœ‰åº§ä½)ã€‚\né•·é€”è»Šç¨‹å»ºè­°æº–å‚™å°ç©å…·æˆ–è²¼ç´™æ›¸å®‰æ’«ã€‚" },
        { d: "D4", route: "æ±å±±ç·š+Linimo", ticket: "24håˆ¸+å–®ç¨‹", price: "Â¥1140", color: "bg-yellow-100 text-yellow-800", tip: "å¤§å€‰åº«å…§ç¦æ¨è»Š (å…¥å£å…è²»å¯„æ”¾)ã€‚\néƒ¨åˆ†å±•å€è¼ƒå†·ï¼Œå¹¼ç«¥è«‹å¸¶è–„å¤–å¥—ã€‚" },
        { d: "D5", route: "åéµå·´å£«", ticket: "å¥—ç¥¨", price: "Â¥3700", color: "bg-purple-100 text-purple-800", tip: "å¥—ç¥¨å«Â¥1000é‡‘åˆ¸ï¼Œå¯åœ¨ Outlet æˆ–ç‡ˆæœƒä½¿ç”¨ã€‚" },
      ];

      // --- HELPERS ---

      const getWeatherIcon = (code) => {
        if (code <= 1) return <Sun size={24} className="text-orange-500" />;
        if (code <= 3) return <Cloud size={24} className="text-gray-400" />;
        if (code <= 48) return <CloudFog size={24} className="text-gray-400" />;
        if (code <= 67) return <CloudRain size={24} className="text-blue-400" />;
        if (code <= 77) return <Snowflake size={24} className="text-blue-300" />;
        if (code <= 82) return <CloudRain size={24} className="text-blue-500" />;
        if (code <= 86) return <Snowflake size={24} className="text-blue-300" />;
        if (code <= 99) return <CloudLightning size={24} className="text-purple-500" />;
        return <Sun size={24} className="text-orange-500" />;
      };

      const openGoogleMaps = (location) => {
        window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(location)}`, '_blank');
      };

      // --- HOOKS ---

      const useNagoyaWeather = () => {
        const [weather, setWeather] = useState(null);
        const [loading, setLoading] = useState(true);

        useEffect(() => {
          // Nagoya Coordinates: 35.1815, 136.9066
          // API: Open-Meteo
          const fetchWeather = async () => {
            try {
              const res = await fetch('https://api.open-meteo.com/v1/forecast?latitude=35.1815&longitude=136.9066&current=temperature_2m,apparent_temperature,weather_code&daily=weather_code,temperature_2m_max,temperature_2m_min&timezone=Asia%2FTokyo');
              const data = await res.json();
              setWeather(data);
            } catch (e) {
              console.error("Weather fetch failed", e);
            } finally {
              setLoading(false);
            }
          };
          fetchWeather();
        }, []);
        return { weather, loading };
      };

      // --- COMPONENTS ---

      const WeeklyForecastWidget = ({ weather, loading }) => {
        if (loading || !weather) return null;
        const daily = weather.daily;

        return (
          <div className="bg-ghibli-green/5 rounded-xl p-2 overflow-hidden mb-4">
            <div className="flex overflow-x-auto gap-3 no-scrollbar items-center px-1">
              <span className="text-[10px] text-ghibli-green font-bold shrink-0 writing-mode-vertical">æœªä¾†ä¸€é€±</span>
              {daily.time.map((t, i) => (
                <div key={i} className="flex flex-col items-center min-w-[2.5rem] shrink-0">
                  <span className="text-[9px] text-gray-500">{new Date(t).toLocaleDateString('zh-TW', {weekday: 'short'})}</span>
                  <div className="my-0.5 scale-75 origin-center">{getWeatherIcon(daily.weather_code[i])}</div>
                  <div className="flex gap-1 text-[10px] font-mono leading-none">
                     <span className="font-bold text-gray-800">{Math.round(daily.temperature_2m_max[i])}</span>
                     <span className="text-gray-400">{Math.round(daily.temperature_2m_min[i])}</span>
                  </div>
                </div>
              ))}
            </div>
          </div>
        );
      };

      const DayCard = ({ day, onClick }) => (
        <div 
          onClick={onClick}
          className="bg-white rounded-xl shadow-sm border border-ghibli-cream/50 overflow-hidden active:scale-[0.98] transition-all duration-200"
        >
          <div className="bg-ghibli-green/10 p-3 flex justify-between items-center">
            <span className="font-bold text-ghibli-green text-lg">{day.dateLabel}</span>
            <div className="flex items-center text-xs text-gray-500 gap-1">
              {day.weather.icon === 'sun' ? <Sun size={14} className="text-orange-400" /> : 
               day.weather.icon === 'cloud' ? <Cloud size={14} className="text-gray-400" /> :
               day.weather.icon === 'snow' ? <Snowflake size={14} className="text-blue-300" /> : null}
              {day.weather.temp}
            </div>
          </div>
          <div className="p-3">
            <h3 className="font-bold text-gray-800 mb-2 truncate">{day.title}</h3>
            <div className="flex flex-wrap gap-1">
              {day.highlights.slice(0, 3).map((h, i) => (
                <span key={i} className="text-[10px] bg-ghibli-cream px-2 py-1 rounded-full text-ghibli-brown">
                  {h}
                </span>
              ))}
            </div>
          </div>
        </div>
      );

      const DayDetailView = ({ day, onBack }) => (
        <div className="animate-fade-in pb-24">
          <div className="bg-ghibli-green text-white p-4 sticky top-0 z-20 shadow-md">
            <button onClick={onBack} className="flex items-center gap-1 mb-2 opacity-80 hover:opacity-100">
              <ChevronLeft size={20} /> è¿”å›è¡Œç¨‹
            </button>
            <div className="flex justify-between items-end">
              <h1 className="text-2xl font-bold">{day.dateLabel} {day.title}</h1>
              <div className="text-right">
                <div className="text-3xl">{day.weather.icon === 'sun' ? 'â˜€ï¸' : day.weather.icon === 'cloud' ? 'â˜ï¸' : 'â„ï¸'}</div>
                <div className="text-sm opacity-90">{day.weather.temp}</div>
              </div>
            </div>
          </div>

          <div className="p-4 space-y-6">
            <section>
              <h2 className="text-lg font-bold text-ghibli-green mb-3 flex items-center gap-2">
                <Clock size={18} /> æ™‚é–“è»¸
              </h2>
              <div className="space-y-4 border-l-2 border-ghibli-green/20 ml-2 pl-4">
                {day.schedule.map((item, idx) => (
                  <div key={idx} className="relative">
                    <div className={`absolute -left-[21px] top-1 w-3 h-3 rounded-full ${item.important ? 'bg-red-400 animate-pulse' : 'bg-ghibli-green'}`}></div>
                    <div className="flex items-baseline justify-between">
                      <span className="font-mono text-ghibli-green font-bold">{item.time}</span>
                      {item.navLink && (
                        <button onClick={() => openGoogleMaps(item.navLink)} className="text-blue-500 text-xs flex items-center gap-1">
                          <Navigation size={12} /> å°èˆª
                        </button>
                      )}
                    </div>
                    <h3 className="font-bold text-gray-800">{item.title}</h3>
                    <p className="text-sm text-gray-600 mt-1">{item.description}</p>
                    {item.important && (
                      <div className="mt-2 bg-red-50 text-red-600 text-xs p-2 rounded flex items-start gap-1">
                        <AlertCircle size={12} className="mt-0.5 shrink-0" />
                        {item.important}
                      </div>
                    )}
                  </div>
                ))}
              </div>
            </section>

            <section>
              <h2 className="text-lg font-bold text-ghibli-orange mb-3 flex items-center gap-2">
                <Utensils size={18} /> é¤é£²æ¨è–¦
              </h2>
              <div className="grid gap-3">
                {day.food.map((f, idx) => (
                  <div key={idx} className={`p-3 rounded-lg border ${f.isPrimary ? 'bg-white border-ghibli-orange/30 shadow-sm' : 'bg-gray-50 border-transparent'}`}>
                    <div className="flex justify-between items-start">
                      <div>
                        <div className="flex items-center gap-2">
                          <span className="font-bold text-gray-800">{f.name}</span>
                          <span className="text-xs text-gray-500 bg-gray-200 px-1.5 py-0.5 rounded">{f.type}</span>
                        </div>
                        <div className="text-xs text-gray-500 mt-1">{f.price}</div>
                        <div className="flex gap-1 mt-2">
                          {f.features.map((tag, i) => (
                            <span key={i} className="text-[10px] px-1.5 py-0.5 rounded border border-ghibli-orange/30 text-ghibli-orange">
                              {tag}
                            </span>
                          ))}
                        </div>
                      </div>
                      {f.navLink && (
                        <button onClick={() => openGoogleMaps(f.navLink)} className="p-2 bg-blue-50 text-blue-500 rounded-full">
                          <Navigation size={16} />
                        </button>
                      )}
                    </div>
                  </div>
                ))}
              </div>
            </section>

            <section className="bg-ghibli-cream/50 p-4 rounded-xl">
              <h2 className="text-lg font-bold text-ghibli-brown mb-2 flex items-center gap-2">
                <Info size={18} /> è¦ªå­å°è²¼å£«
              </h2>
              <ul className="space-y-2">
                {day.tips.map((tip, idx) => (
                  <li key={idx} className="text-sm text-gray-700 flex gap-2">
                    <span className="text-ghibli-green">â€¢</span> {tip}
                  </li>
                ))}
              </ul>
            </section>
          </div>
        </div>
      );

      const ExpenseTracker = () => {
        const [items, setItems] = useState(() => {
            try { return JSON.parse(localStorage.getItem('trip_expenses')) || [] } 
            catch { return [] }
        });
        const [name, setName] = useState('');
        const [price, setPrice] = useState('');
        const [cat, setCat] = useState('ğŸ”');

        const cats = [
            {i:'ğŸ”', n:'é¤é£²'}, {i:'ğŸšŒ', n:'äº¤é€š'}, {i:'ğŸ›ï¸', n:'è³¼ç‰©'}, 
            {i:'ğŸ«', n:'é–€ç¥¨'}, {i:'ğŸ ', n:'ä½å®¿'}, {i:'ğŸ“¦', n:'å…¶ä»–'}
        ];

        useEffect(() => localStorage.setItem('trip_expenses', JSON.stringify(items)), [items]);

        const add = () => {
            if(!name || !price) return;
            setItems([{id: Date.now(), n: name, p: parseInt(price), c: cat}, ...items]);
            setName(''); setPrice('');
        };
        
        const del = (id) => setItems(items.filter(i => i.id !== id));
        const total = items.reduce((a, b) => a + (b.p || 0), 0);

        return (
            <div className="bg-white p-4 rounded-xl shadow-sm border border-ghibli-green/20">
                <h3 className="font-bold text-ghibli-green mb-3 flex items-center gap-2">
                    <Receipt size={18} /> é›¢ç·šè¨˜å¸³å°å¹«æ‰‹
                </h3>
                {/* Modified Inputs Layout (2 Rows) */}
                <div className="space-y-3 mb-4">
                  <div className="flex gap-2">
                     <select value={cat} onChange={e=>setCat(e.target.value)} className="bg-gray-50 rounded-lg p-2.5 outline-none text-sm w-1/3 appearance-none text-center border border-transparent focus:border-ghibli-green/30 transition-all">
                        {cats.map(c => <option key={c.i} value={c.i}>{c.i} {c.n}</option>)}
                     </select>
                     <input value={name} onChange={e=>setName(e.target.value)} placeholder="æ¶ˆè²»é …ç›®" className="flex-1 bg-gray-50 p-2.5 rounded-lg outline-none text-sm border border-transparent focus:border-ghibli-green/30 transition-all" />
                  </div>
                  <div className="flex gap-2">
                     <div className="relative w-5/12">
                       <span className="absolute left-3 top-2.5 text-gray-400 text-xs">Â¥</span>
                       <input value={price} onChange={e=>setPrice(e.target.value)} type="number" placeholder="é‡‘é¡" className="w-full bg-gray-50 pl-7 p-2.5 rounded-lg outline-none text-sm font-mono border border-transparent focus:border-ghibli-green/30 transition-all" />
                     </div>
                     <button onClick={add} className="flex-1 bg-ghibli-green text-white py-2 rounded-lg font-bold text-sm flex items-center justify-center gap-1 shadow-sm hover:bg-ghibli-green/90 active:scale-95 transition-all">
                        <Plus size={16} /> è¨˜ä¸€ç­†
                     </button>
                  </div>
                </div>

                {/* List */}
                <div className="max-h-48 overflow-y-auto space-y-2 mb-3 pr-1 custom-scrollbar">
                    {items.map(i => (
                        <div key={i.id} className="flex justify-between items-center text-sm border-b border-gray-50 pb-2 last:border-0">
                            <span className="flex items-center gap-2 text-gray-700">
                              <span className="bg-gray-100 p-1 rounded">{i.c}</span>
                              <span className="truncate max-w-[8rem]">{i.n}</span>
                            </span>
                            <div className="flex items-center gap-3">
                                <span className="font-mono font-bold text-gray-600">Â¥{i.p.toLocaleString()}</span>
                                <button onClick={()=>del(i.id)} className="text-gray-300 hover:text-red-500 p-1"><Trash2 size={14}/></button>
                            </div>
                        </div>
                    ))}
                    {items.length === 0 && <div className="text-center text-gray-300 text-xs py-4 border-2 border-dashed border-gray-100 rounded-lg">é‚„æ²’æœ‰æ¶ˆè²»ç´€éŒ„</div>}
                </div>
                {/* Total */}
                <div className="flex justify-between items-center pt-3 border-t border-gray-100">
                    <span className="text-gray-500 font-bold text-sm">ç›®å‰ç¸½æ”¯å‡º</span>
                    <span className="text-xl font-bold text-ghibli-orange font-mono">Â¥{total.toLocaleString()}</span>
                </div>
            </div>
        )
      };

      const ToolsView = () => {
        const [checklist, setChecklist] = useState({
          passport: false, license: false, insurance: false, 
          clothes: false, medicine: false, charger: false,
          cash: false, credit: false
        });

        const toggleCheck = (key) => setChecklist(prev => ({...prev, [key]: !prev[key]}));

        return (
          <div className="p-4 space-y-6 pb-24 animate-fade-in">
            <h1 className="text-2xl font-bold text-ghibli-brown mb-4">æ—…éŠå·¥å…·ç®±</h1>
            
            <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
              <h3 className="font-bold text-gray-800 flex items-center gap-2 mb-3">
                <Plane size={18} className="text-blue-500" /> èˆªç­è³‡è¨Š
              </h3>
              <div className="space-y-3 text-sm">
                <div className="flex justify-between p-2 bg-gray-50 rounded">
                  <span>å»ç¨‹ (D1)</span>
                  <span className="font-mono font-bold">17:15 â†’ 20:50</span>
                </div>
                <div className="flex justify-between p-2 bg-gray-50 rounded">
                  <span>å›ç¨‹ (D8)</span>
                  <span className="font-mono font-bold">09:50 â†’ 12:15</span>
                </div>
              </div>
            </div>

            <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
              <h3 className="font-bold text-gray-800 flex items-center gap-2 mb-3">
                <ClipboardCheck size={18} className="text-green-500" /> è¡Œå‰æª¢æŸ¥
              </h3>
              <div className="grid grid-cols-2 gap-2">
                {[
                  {k: 'passport', l: 'è­·ç…§ (æ•ˆæœŸ6å€‹æœˆ+)'}, {k: 'license', l: 'é§•ç…§æ—¥æ–‡è­¯æœ¬'},
                  {k: 'insurance', l: 'æ—…éŠä¿éšªå–®'}, {k: 'clothes', l: 'æ´‹è”¥å¼è¡£ç‰©'},
                  {k: 'medicine', l: 'å¸¸å‚™è—¥/é€€ç†±è²¼'}, {k: 'charger', l: 'å……é›»å™¨/è½‰æ¥é ­'},
                  {k: 'cash', l: 'æ—¥å¹£ç¾é‡‘'}, {k: 'credit', l: 'ä¿¡ç”¨å¡ (æµ·å¤–å›é¥‹)'}
                ].map((item) => (
                  <button 
                    key={item.k}
                    onClick={() => toggleCheck(item.k)}
                    className={`p-2 rounded text-xs text-left flex items-center gap-2 transition-colors ${checklist[item.k] ? 'bg-green-100 text-green-800' : 'bg-gray-50 text-gray-500'}`}
                  >
                    {checklist[item.k] ? <CheckCircle size={14} /> : <div className="w-3.5 h-3.5 rounded-full border border-gray-300" />}
                    {item.l}
                  </button>
                ))}
              </div>
            </div>

            {/* Offline Expense Tracker */}
            <ExpenseTracker />
          </div>
        );
      };

      const CurrencyView = () => {
        const [rate, setRate] = useState(0.215);
        const [amount, setAmount] = useState('');
        const [loading, setLoading] = useState(false);

        const fetchRate = async () => {
          setLoading(true);
          try {
            const res = await fetch('https://api.exchangerate-api.com/v4/latest/JPY');
            const data = await res.json();
            if (data && data.rates && data.rates.TWD) {
              setRate(data.rates.TWD);
            }
          } catch (e) {
            console.error("Rate fetch failed", e);
          } finally {
            setLoading(false);
          }
        };

        useEffect(() => { fetchRate(); }, []);

        const calculated = amount ? (parseFloat(amount) * rate).toFixed(0) : 0;

        return (
          <div className="p-4 space-y-6 pb-24 animate-fade-in">
             <h1 className="text-2xl font-bold text-ghibli-brown mb-4">åŒ¯ç‡æ›ç®—</h1>
             <div className="bg-white p-6 rounded-2xl shadow-sm border border-ghibli-green/20 text-center space-y-4">
               <div className="flex justify-center items-center gap-2 text-gray-500 text-sm">
                 <span>å³æ™‚åŒ¯ç‡ (JPY â†’ TWD)</span>
                 <button onClick={fetchRate} disabled={loading} className="p-1 hover:bg-gray-100 rounded-full">
                   <RefreshCw size={14} className={loading ? 'animate-spin' : ''} />
                 </button>
               </div>
               <div className="text-4xl font-bold text-ghibli-green font-mono">
                 {rate.toFixed(3)}
               </div>
               
               <div className="bg-gray-50 p-4 rounded-xl flex items-center gap-3 border border-gray-200">
                 <span className="text-gray-500 font-bold">Â¥</span>
                 <input 
                   type="number" 
                   value={amount}
                   onChange={(e) => setAmount(e.target.value)}
                   placeholder="è¼¸å…¥æ—¥å¹£..."
                   className="bg-transparent text-2xl font-bold text-gray-800 w-full outline-none placeholder-gray-300"
                 />
               </div>
               
               <div className="flex items-center justify-center gap-2 text-gray-400">
                 <ArrowRightLeft size={16} className="rotate-90" />
               </div>

               <div className="bg-ghibli-green/10 p-4 rounded-xl">
                 <div className="text-sm text-gray-500 mb-1">ç´„åˆå°å¹£</div>
                 <div className="text-3xl font-bold text-ghibli-green">
                   ${Number(calculated).toLocaleString()}
                 </div>
               </div>

               <div className="text-xs text-gray-400 mt-4">
                 è³‡æ–™ä¾†æº: <a href="https://www.exchangerate-api.com" target="_blank" className="underline text-blue-400">ExchangeRate-API</a> (åœ‹éš›å¸‚å ´ä¸­é–“åƒ¹)
               </div>
             </div>
          </div>
        );
      };

      const TransportView = ({ onBack }) => (
        <div className="animate-fade-in pb-24">
          <div className="bg-blue-600 text-white p-4 sticky top-0 z-20 shadow-md flex items-center gap-2">
            <button onClick={onBack}><ChevronLeft /></button>
            <h1 className="text-xl font-bold">äº¤é€šç¥¨åˆ¸é™„éŒ„</h1>
          </div>
          <div className="p-4 space-y-6">
            <section>
              <h2 className="text-lg font-bold text-blue-700 mb-2 flex items-center gap-2">
                <Ticket size={18} /> 4 æ­²å¹¼ç«¥ç¥¨åˆ¸è¦å‰‡
              </h2>
              <div className="overflow-x-auto rounded-lg border border-gray-200 shadow-sm">
                <table className="w-full text-sm text-left">
                  <thead className="bg-gray-100 text-gray-700">
                    <tr><th className="p-2">äº¤é€šæ–¹å¼</th><th className="p-2">éœ€è³¼ç¥¨?</th><th className="p-2">å‚™è¨»</th></tr>
                  </thead>
                  <tbody className="bg-white divide-y divide-gray-100">
                    <tr><td className="p-2">åœ°éµå…¨ç·š</td><td className="p-2 font-bold text-green-600">å…ç¥¨</td><td className="p-2 text-gray-500">ä¸ä½”ä½</td></tr>
                    <tr><td className="p-2">åéµä¸€èˆ¬è»Š</td><td className="p-2 font-bold text-green-600">å…ç¥¨</td><td className="p-2 text-gray-500">å¯å…±å</td></tr>
                    <tr><td className="p-2">åéµ ÂµSKY</td><td className="p-2 font-bold text-red-500">éœ€ç¥¨</td><td className="p-2 text-gray-500">è‹¥ä½”æŒ‡å®šå¸­</td></tr>
                    <tr><td className="p-2">å·´å£«åœ˜</td><td className="p-2 font-bold text-blue-500">å«åœ¨åœ˜è²»</td><td className="p-2 text-gray-500">å¤šæ•¸å«</td></tr>
                  </tbody>
                </table>
              </div>
            </section>

            <section>
              <h2 className="text-lg font-bold text-blue-700 mb-2">æ¯æ—¥äº¤é€šç¸½è¡¨</h2>
              <div className="space-y-3">
                {TRANSPORT_TICKETS.map((row, i) => (
                  <div key={i} className="flex flex-col gap-2 p-3 bg-white rounded-lg border border-gray-100 shadow-sm">
                    <div className="flex items-center gap-3">
                      <span className="font-bold text-gray-500 w-8">{row.d}</span>
                      <span className={`text-xs px-2 py-1 rounded ${row.color}`}>{row.route}</span>
                      <div className="flex-1 text-right text-sm">
                        <div className="font-bold">{row.ticket}</div>
                        <div className="text-gray-500 text-xs">{row.price}</div>
                      </div>
                    </div>
                    {row.tip && (
                      <div className="bg-ghibli-green/5 p-2 rounded text-xs text-gray-600 flex gap-2">
                        <span className="text-ghibli-green font-bold">ğŸ’¡</span>
                        <span className="whitespace-pre-line">{row.tip}</span>
                      </div>
                    )}
                  </div>
                ))}
              </div>
            </section>
          </div>
        </div>
      );

      const FoodListView = ({ onBack }) => (
        <div className="animate-fade-in pb-24">
          <div className="bg-orange-500 text-white p-4 sticky top-0 z-20 shadow-md flex items-center gap-2">
            <button onClick={onBack}><ChevronLeft /></button>
            <h1 className="text-xl font-bold">ç¾é£Ÿé™„éŒ„ (å®Œæ•´ç‰ˆ)</h1>
          </div>
          <div className="p-4 space-y-6">
            {ITINERARY_DATA.map((day) => (
              <div key={day.id} className="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                <div className="bg-orange-50 px-4 py-2 font-bold text-orange-800 text-sm flex justify-between">
                  <span>{day.dateLabel} {day.title}</span>
                </div>
                <div className="divide-y divide-gray-100">
                  {day.food.map((f, i) => (
                    <div key={i} className="p-3 flex justify-between items-center">
                      <div>
                        <div className="font-bold text-gray-800">{f.name}</div>
                        <div className="text-xs text-gray-500 mt-1">{f.type} â€¢ {f.price}</div>
                      </div>
                      <div className="text-xs px-2 py-1 bg-gray-100 rounded text-gray-600">
                        {f.features[0]}
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            ))}
          </div>
        </div>
      );

      const FullMapView = ({ onBack }) => (
        <div className="animate-fade-in pb-24">
          <div className="bg-teal-600 text-white p-4 sticky top-0 z-20 shadow-md flex items-center gap-2">
            <button onClick={onBack}><ChevronLeft /></button>
            <h1 className="text-xl font-bold">å®Œæ•´è³¼ç‰©åœ°åœ–</h1>
          </div>
          
          <div className="p-4 space-y-6">
            <div className="bg-blue-50 p-4 rounded-lg text-sm text-blue-800">
              <p>ğŸ›ï¸ <strong>åå¤å±‹ç«™å¤ªé–¤é€šå£</strong> (Daiwa Roynet é£¯åº—å‘¨é‚Š) è£œçµ¦æ”»ç•¥ã€‚</p>
            </div>

            <section>
              <h2 className="text-lg font-bold text-teal-800 mb-3 flex items-center gap-2">
                <MapPin size={18} /> å‘¨é‚Šåº—å®¶åˆ—è¡¨
              </h2>
              <div className="grid gap-3">
                {TAIKO_SHOPS.map((shop, i) => (
                  <div key={i} className="bg-white p-3 rounded-lg border border-gray-200 shadow-sm flex justify-between items-start">
                    <div>
                      <div className="font-bold text-gray-800 flex items-center gap-2">
                        {shop.name}
                        <span className="text-[10px] bg-gray-100 px-1 rounded text-gray-500">{shop.dist}</span>
                      </div>
                      <div className="text-xs text-gray-500 mt-1">{shop.type} â€¢ {shop.tag}</div>
                      <div className="text-xs text-teal-600 mt-1 font-bold">{shop.note}</div>
                    </div>
                    <button onClick={() => openGoogleMaps(shop.navLink)} className="p-2 bg-gray-50 rounded-full text-blue-500">
                      <Navigation size={16} />
                    </button>
                  </div>
                ))}
              </div>
            </section>

            <section>
              <h2 className="text-lg font-bold text-teal-800 mb-3 flex items-center gap-2">
                <Footprints size={18} /> æ¨è–¦è£œçµ¦è·¯ç·š
              </h2>
              <div className="space-y-3">
                {TAIKO_ROUTES.map((route, i) => (
                  <div key={i} className="bg-white p-3 rounded-lg border-l-4 border-teal-500 shadow-sm">
                    <div className="flex justify-between">
                      <h3 className="font-bold text-gray-800">{route.title}</h3>
                      <span className="text-xs bg-teal-50 text-teal-700 px-2 py-0.5 rounded-full">{route.tag}</span>
                    </div>
                    <p className="text-sm text-gray-600 mt-1">{route.desc}</p>
                  </div>
                ))}
              </div>
            </section>
          </div>
        </div>
      );

      const TaikoShoppingView = ({ onBack }) => (
        <div className="animate-fade-in pb-24">
          <div className="bg-yellow-500 text-white p-4 sticky top-0 z-20 shadow-md flex items-center gap-2">
            <button onClick={onBack}><ChevronLeft /></button>
            <h1 className="text-xl font-bold">å¤ªé–¤é€šå£è³¼ç‰©æ”»ç•¥</h1>
          </div>
          
          <div className="p-4 space-y-6">
            <div className="bg-yellow-50 border border-yellow-200 p-4 rounded-xl">
              <h2 className="text-lg font-bold text-yellow-800 mb-4 flex items-center gap-2">
                <Store size={18} /> Donki æ¦®æœ¬åº— 15 é …å¿…è²·
              </h2>
              <div className="space-y-4">
                {DONKI_MUST_BUY.map((cat, i) => (
                  <div key={i}>
                    <h3 className="font-bold text-yellow-900 bg-yellow-200/50 px-2 py-1 rounded mb-2 text-sm">{cat.category}</h3>
                    <ul className="space-y-2">
                      {cat.items.map((item, j) => (
                        <li key={j} className="flex items-center gap-2 text-sm text-gray-700 bg-white p-2 rounded border border-yellow-100 shadow-sm">
                          <CheckCircle size={14} className="text-yellow-500 shrink-0" />
                          {item}
                        </li>
                      ))}
                    </ul>
                  </div>
                ))}
              </div>
              <div className="mt-4 text-xs text-gray-500 bg-white p-2 rounded">
                 å»ºè­°é †åº: 1F(é›¶é£Ÿ) â†’ 2F(è—¥å¦) â†’ 3F(å…’ç«¥) â†’ çµå¸³
              </div>
            </div>

            <section>
               <h2 className="text-lg font-bold text-gray-800 mb-2">å‘¨é‚Šè¶…å¸‚åœ°åœ–</h2>
               <div className="bg-white p-3 rounded-lg shadow-sm border border-gray-200">
                 {TAIKO_SHOPS.filter(s => s.type === 'è¶…å¸‚').map((shop, i) => (
                   <div key={i} className="flex justify-between items-center py-2 border-b last:border-0 border-gray-100">
                     <div>
                       <div className="font-bold">{shop.name}</div>
                       <div className="text-xs text-gray-500">{shop.tag}</div>
                     </div>
                     <button onClick={() => openGoogleMaps(shop.navLink)} className="text-blue-500 text-sm">å°èˆª</button>
                   </div>
                 ))}
               </div>
            </section>
          </div>
        </div>
      );

      const AIConciergeModal = ({ onClose }) => {
        const [status, setStatus] = useState('INPUT'); // INPUT, LOCATING, THINKING, RESULT, ERROR
        const [result, setResult] = useState('');
        const [userInput, setUserInput] = useState('');

        const handleLocateAndAsk = () => {
          if (!process.env.API_KEY) {
            setStatus('ERROR');
            setResult('å®‰å…¨æ€§éŒ¯èª¤ï¼šAPI Key å°šæœªè¨­å®šã€‚è«‹åœ¨ç’°å¢ƒè®Šæ•¸ä¸­è¨­å®š API_KEYã€‚');
            return;
          }
          if (!navigator.geolocation) {
            alert('æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´åœ°ç†å®šä½åŠŸèƒ½ã€‚');
            return;
          }

          setStatus('LOCATING');
          navigator.geolocation.getCurrentPosition(
            (pos) => {
              const { latitude, longitude } = pos.coords;
              askGemini(`æˆ‘ç¾åœ¨ä½ç½®åœ¨ç·¯åº¦ ${latitude}, ç¶“åº¦ ${longitude}ã€‚è«‹æ¨è–¦é™„è¿‘ 3 å€‹é©åˆå¸¶ 4 æ­²å°å­©å»çš„é¤å»³æˆ–æ™¯é»ã€‚`);
            },
            (err) => {
              console.error(err);
              setStatus('INPUT');
              alert('ç„¡æ³•ç²å–æ‚¨çš„ä½ç½®ï¼Œè«‹ç›´æ¥è¼¸å…¥æ‚¨çš„å•é¡Œã€‚');
            }
          );
        };

        const handleTextAsk = () => {
          if (!process.env.API_KEY) {
             setStatus('ERROR');
             setResult('å®‰å…¨æ€§éŒ¯èª¤ï¼šAPI Key å°šæœªè¨­å®šã€‚è«‹åœ¨ç’°å¢ƒè®Šæ•¸ä¸­è¨­å®š API_KEYã€‚');
             return;
          }
          if (!userInput.trim()) return;
          askGemini(userInput);
        };

        const askGemini = async (promptText) => {
          setStatus('THINKING');
          try {
            const systemPrompt = `ä½ æ˜¯ä¸€ä½å°ˆæ¥­çš„åå¤å±‹è¦ªå­æ—…éŠå°éŠã€‚
ä½ çš„èªæ°£è¦ªåˆ‡ã€ç†±æƒ…ï¼Œç‰¹åˆ¥å°ˆæ³¨æ–¼ 4 æ­²å…’ç«¥çš„éœ€æ±‚ï¼ˆå¦‚å…’ç«¥åº§æ¤…ã€å°¿å¸ƒå°ã€æ¨è»Šä¾¿åˆ©æ€§ã€å…’ç«¥é¤ï¼‰ã€‚
è«‹ç”¨ç¹é«”ä¸­æ–‡å›ç­”ï¼Œä¸¦ä»¥æ¢åˆ—å¼ Markdown æ ¼å¼å‘ˆç¾ã€‚
å¦‚æœä½¿ç”¨è€…è¼¸å…¥çš„æ˜¯åœ°é»ï¼ˆå¦‚ã€Œæ¦®ç«™ã€ã€ã€Œåå¤å±‹åŸã€ï¼‰ï¼Œè«‹æ¨è–¦è©²åœ°é™„è¿‘ 3 å€‹é©åˆè¦ªå­ç”¨é¤æˆ–ä¼‘æ†©çš„åœ°é»ã€‚
å¦‚æœä½¿ç”¨è€…è¼¸å…¥çš„æ˜¯å•é¡Œï¼Œè«‹æä¾›å°ˆæ¥­çš„è¦ªå­æ—…éŠå»ºè­°ã€‚
æ¨è–¦åœ°é»æ ¼å¼è«‹åŒ…å«ï¼š
1. **åœ°é»åç¨±** (å«æ—¥æ–‡åŸå)
2. **åœ°åœ–é€£çµ**ï¼šè«‹æä¾› [é–‹å•Ÿ Google åœ°åœ–] çš„ Markdown é€£çµï¼Œç¶²å€æ ¼å¼ç‚º https://www.google.com/maps/search/?api=1&query=åœ°é»åç¨± (è«‹å°‡åœ°é»åç¨±å¡«å…¥ query)
3. **è·é›¢/ä½ç½®**
4. **æ¨è–¦ç†ç”±** (é‡å°è¦ªå­)
5. **å¯¦ç”¨è³‡è¨Š** (ç‡Ÿæ¥­æ™‚é–“ã€é ç®—)`;

            // Initialize with the secure process.env.API_KEY
            const ai = new GoogleGenAI({ apiKey: process.env.API_KEY });
            const response = await ai.models.generateContent({
              model: 'gemini-2.5-flash',
              contents: promptText,
              config: {
                systemInstruction: systemPrompt,
              }
            });

            const text = response.text;

            if (text) {
              setResult(text);
              setStatus('RESULT');
            } else {
              throw new Error('No content returned');
            }
          } catch (e) {
            console.error(e);
            setStatus('ERROR');
            // Show detailed error message
            setResult(`AI æš«æ™‚ç„¡æ³•å›æ‡‰ã€‚(${e.message || 'æœªçŸ¥éŒ¯èª¤'}) è«‹æª¢æŸ¥ API Key è¨­å®šã€‚`);
          }
        };

        const reset = () => {
          setStatus('INPUT');
          setResult('');
          setUserInput('');
        };

        return (
          <div className="fixed inset-0 z-[60] flex items-end justify-center sm:items-center p-4 bg-black/50 backdrop-blur-sm animate-fade-in">
            <div className="bg-white w-full max-w-md rounded-2xl p-5 shadow-2xl max-h-[85vh] overflow-y-auto relative flex flex-col">
              <button onClick={onClose} className="absolute top-4 right-4 text-gray-400 hover:text-gray-600 z-10">
                <XCircle size={24} />
              </button>

              <div className="flex flex-col items-center mb-6 shrink-0">
                <div className="w-12 h-12 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-full flex items-center justify-center text-white mb-2 shadow-lg">
                  <Sparkles size={24} />
                </div>
                <h2 className="text-xl font-bold text-gray-800">AI éš¨èº«å°éŠ</h2>
                <p className="text-xs text-gray-500">æœ‰ä»€éº¼æˆ‘å¯ä»¥å¹«æ‚¨çš„å—ï¼Ÿ</p>
              </div>

              {status === 'INPUT' && (
                <div className="flex flex-col gap-4 animate-fade-in">
                  <div className="bg-blue-50 p-3 rounded-lg text-xs text-blue-700 mb-2">
                    ğŸ’¡ <strong>å°æç¤ºï¼š</strong> å³ä½¿ä¸é–‹å®šä½ï¼Œä¹Ÿå¯ä»¥ç›´æ¥è¼¸å…¥åœ°é»ï¼ˆå¦‚ã€Œæˆ‘åœ¨å¤§é ˆå•†åº—è¡—ã€ï¼‰ä¾†è©¢å•å–”ï¼
                  </div>
                  <textarea
                    className="w-full p-4 bg-gray-50 border border-gray-200 rounded-xl text-gray-700 focus:outline-none focus:ring-2 focus:ring-purple-500 resize-none h-32"
                    placeholder="è¼¸å…¥åœ°é» (å¦‚: åå¤å±‹åŸ) æˆ–æƒ³å•çš„å•é¡Œ (å¦‚: å“ªè£¡æœ‰è³£å°¿å¸ƒ?)..."
                    value={userInput}
                    onChange={(e) => setUserInput(e.target.value)}
                  ></textarea>
                  
                  <div className="flex flex-col gap-2">
                    <button 
                      onClick={handleTextAsk}
                      disabled={!userInput.trim()}
                      className="w-full bg-gradient-to-r from-indigo-500 to-purple-600 text-white py-3 rounded-xl font-bold shadow-md hover:opacity-90 active:scale-95 transition-all disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2"
                    >
                      <Sparkles size={18} />
                      âœ¨ ç›´æ¥é€å‡º (ä¸éœ€å®šä½)
                    </button>
                    
                    <button 
                      onClick={handleLocateAndAsk}
                      className="w-full bg-white border border-gray-200 text-gray-500 py-3 rounded-xl text-sm hover:bg-gray-50 active:scale-95 transition-all flex items-center justify-center gap-2"
                    >
                      <MapPin size={16} />
                      ğŸ“ å®šä½ä¸¦æ¨è–¦ (é™„è¿‘æ™¯é»)
                    </button>
                  </div>
                </div>
              )}

              {status === 'LOCATING' && (
                <div className="flex flex-col items-center py-12 text-gray-500 gap-3 animate-fade-in">
                  <MapPin className="animate-bounce text-indigo-500" size={32} />
                  <span>æ­£åœ¨ç²å–æ‚¨çš„ä½ç½®...</span>
                </div>
              )}

              {status === 'THINKING' && (
                <div className="flex flex-col items-center py-12 text-gray-500 gap-3 animate-fade-in">
                  <Loader2 className="animate-spin text-purple-500" size={32} />
                  <span>AI å°éŠæ­£åœ¨æ€è€ƒä¸­...</span>
                </div>
              )}

              {status === 'RESULT' && (
                <div className="flex flex-col gap-4 animate-fade-in flex-1 overflow-hidden">
                  <div className="prose prose-sm max-w-none text-gray-700 markdown-body bg-gray-50 p-4 rounded-xl border border-gray-100 overflow-y-auto max-h-[50vh]">
                    <div dangerouslySetInnerHTML={{ 
                      __html: result
                        .replace(/^### (.*$)/gim, '<h3 class="font-bold text-ghibli-green mt-4 mb-2">$1</h3>')
                        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                        .replace(/\[(.*?)\]\((.*?)\)/g, '<a href="$2" target="_blank" class="text-blue-500 font-bold hover:underline inline-flex items-center gap-1">$1 <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line></svg></a>')
                        .replace(/^\* (.*$)/gim, '<li class="ml-4 list-disc">$1</li>')
                        .replace(/\n/g, '<br/>')
                    }} />
                  </div>
                  <button 
                    onClick={reset}
                    className="w-full bg-gray-100 text-gray-700 py-3 rounded-xl font-bold hover:bg-gray-200 active:scale-95 transition-all"
                  >
                    å†å•ä¸€æ¬¡
                  </button>
                </div>
              )}

              {status === 'ERROR' && (
                <div className="flex flex-col gap-4 animate-fade-in">
                  <div className="bg-red-50 text-red-600 p-4 rounded-xl text-center text-sm border border-red-100">
                    <AlertCircle className="mx-auto mb-2" size={24} />
                    <span className="font-mono text-xs break-all">{result}</span>
                  </div>
                  <button 
                    onClick={() => setStatus('INPUT')}
                    className="w-full bg-gray-100 text-gray-700 py-3 rounded-xl font-bold hover:bg-gray-200 active:scale-95 transition-all"
                  >
                    é‡è©¦
                  </button>
                </div>
              )}
            </div>
          </div>
        );
      };

      const BottomNav = ({ activeTab, onTabChange }) => (
        <div className="fixed bottom-6 left-1/2 -translate-x-1/2 bg-white/90 backdrop-blur-md border border-gray-200 shadow-2xl rounded-full px-6 py-3 flex items-center gap-8 z-50">
          <button 
            onClick={() => onTabChange('HOME')}
            className={`flex flex-col items-center gap-1 transition-all ${activeTab === 'HOME' ? 'text-ghibli-green scale-110' : 'text-gray-400'}`}
          >
            <Calendar size={24} />
            <span className="text-[10px] font-bold">è¡Œç¨‹</span>
          </button>
          <div className="w-px h-8 bg-gray-200"></div>
          <button 
            onClick={() => onTabChange('CURRENCY')}
            className={`flex flex-col items-center gap-1 transition-all ${activeTab === 'CURRENCY' ? 'text-blue-500 scale-110' : 'text-gray-400'}`}
          >
            <Banknote size={24} />
            <span className="text-[10px] font-bold">åŒ¯ç‡</span>
          </button>
          <div className="w-px h-8 bg-gray-200"></div>
          <button 
            onClick={() => onTabChange('TOOLS')}
            className={`flex flex-col items-center gap-1 transition-all ${activeTab === 'TOOLS' ? 'text-ghibli-orange scale-110' : 'text-gray-400'}`}
          >
            <Wallet size={24} />
            <span className="text-[10px] font-bold">å·¥å…·</span>
          </button>
        </div>
      );

      const App = () => {
        const [activeTab, setActiveTab] = useState('HOME');
        const [selectedDayId, setSelectedDayId] = useState(null);
        const [view, setView] = useState('MAIN'); // MAIN, TRANSPORT, FOOD, FULL_MAP, TAIKO_SHOPPING
        const [showAI, setShowAI] = useState(false);
        
        // Lift weather state to App so header can access it
        const { weather, loading } = useNagoyaWeather();

        const handleTabChange = (tab) => {
          setActiveTab(tab);
          if (tab !== 'HOME') {
            setSelectedDayId(null);
            setView('MAIN');
          }
        };

        const renderHome = () => {
          if (view === 'TRANSPORT') return <TransportView onBack={() => setView('MAIN')} />;
          if (view === 'FOOD') return <FoodListView onBack={() => setView('MAIN')} />;
          if (view === 'FULL_MAP') return <FullMapView onBack={() => setView('MAIN')} />;
          if (view === 'TAIKO_SHOPPING') return <TaikoShoppingView onBack={() => setView('MAIN')} />;
          
          if (selectedDayId) {
            const day = ITINERARY_DATA.find(d => d.id === selectedDayId);
            return <DayDetailView day={day} onBack={() => setSelectedDayId(null)} />;
          }

          return (
            <div className="p-4 space-y-6 pb-24 animate-fade-in">
              <header className="flex justify-between items-center mb-2">
                <div>
                  <h1 className="text-2xl font-bold text-ghibli-green">åå¤å±‹è¦ªå­éŠ</h1>
                  <p className="text-sm text-gray-500">8 å¤© 7 å¤œè‡ªé§•è¡Œç¨‹</p>
                </div>
                {/* Weather Badge in Header */}
                <div className="bg-ghibli-cream border border-ghibli-green/20 px-3 py-1.5 rounded-xl flex items-center gap-2 shadow-sm">
                  {loading ? (
                    <span className="text-xs text-gray-400">è¼‰å…¥ä¸­...</span>
                  ) : weather ? (
                    <>
                      <div className="scale-75 origin-center">{getWeatherIcon(weather.current.weather_code)}</div>
                      <div className="text-right">
                        <div className="text-sm font-bold text-ghibli-green leading-none">{Math.round(weather.current.temperature_2m)}Â°C</div>
                        <div className="text-[10px] text-gray-500 leading-none mt-0.5">é«”æ„Ÿ {Math.round(weather.current.apparent_temperature)}Â°</div>
                      </div>
                    </>
                  ) : (
                    <span className="text-xs text-gray-400">N/A</span>
                  )}
                </div>
              </header>

              <WeeklyForecastWidget weather={weather} loading={loading} />

              <div className="grid grid-cols-2 gap-3">
                {ITINERARY_DATA.map(day => (
                  <DayCard key={day.id} day={day} onClick={() => setSelectedDayId(day.id)} />
                ))}
              </div>

              <section>
                <h2 className="text-lg font-bold text-gray-700 mb-3 ml-1">å¯¦ç”¨é™„éŒ„</h2>
                <div className="space-y-3">
                  <div onClick={() => setView('TRANSPORT')} className="bg-white p-4 rounded-xl shadow-sm border border-blue-100 flex items-center gap-4 active:scale-95 transition-transform">
                    <div className="bg-blue-100 p-3 rounded-full text-blue-600"><Ticket size={24} /></div>
                    <div>
                      <h3 className="font-bold text-gray-800">äº¤é€šç¥¨åˆ¸</h3>
                      <p className="text-xs text-gray-500">å¹¼ç«¥è¦å‰‡ã€æ¯æ—¥ç¥¨åˆ¸ç¸½è¦½</p>
                    </div>
                    <ChevronLeft className="ml-auto rotate-180 text-gray-300" />
                  </div>
                  
                  <div onClick={() => setView('FOOD')} className="bg-white p-4 rounded-xl shadow-sm border border-orange-100 flex items-center gap-4 active:scale-95 transition-transform">
                    <div className="bg-orange-100 p-3 rounded-full text-orange-600"><Utensils size={24} /></div>
                    <div>
                      <h3 className="font-bold text-gray-800">ç¾é£Ÿé™„éŒ„</h3>
                      <p className="text-xs text-gray-500">å®Œæ•´è¡¨æ ¼ç‰ˆ (å«å»ºè­°æ™‚æ®µ)</p>
                    </div>
                    <ChevronLeft className="ml-auto rotate-180 text-gray-300" />
                  </div>

                  <div onClick={() => setView('FULL_MAP')} className="bg-white p-4 rounded-xl shadow-sm border border-teal-100 flex items-center gap-4 active:scale-95 transition-transform">
                    <div className="bg-teal-100 p-3 rounded-full text-teal-600"><Map size={24} /></div>
                    <div>
                      <h3 className="font-bold text-gray-800">å®Œæ•´è³¼ç‰©åœ°åœ–</h3>
                      <p className="text-xs text-gray-500">è¶…å¸‚ï¼‹è—¥å¦ï¼‹å¹³åƒ¹åº—æ¸…å–®</p>
                    </div>
                    <ChevronLeft className="ml-auto rotate-180 text-gray-300" />
                  </div>

                  <div onClick={() => setView('TAIKO_SHOPPING')} className="bg-white p-4 rounded-xl shadow-sm border border-yellow-100 flex items-center gap-4 active:scale-95 transition-transform">
                    <div className="bg-yellow-100 p-3 rounded-full text-yellow-600"><ShoppingBag size={24} /></div>
                    <div>
                      <h3 className="font-bold text-gray-800">å¤ªé–¤é€šå£è³¼ç‰©</h3>
                      <p className="text-xs text-gray-500">Donki æ‡¶äººåŒ… & è£œçµ¦æ”»ç•¥</p>
                    </div>
                    <ChevronLeft className="ml-auto rotate-180 text-gray-300" />
                  </div>
                </div>
              </section>
            </div>
          );
        };

        return (
          <div className="max-w-md mx-auto min-h-screen bg-[#f4f1ea] shadow-xl overflow-hidden relative font-sans text-gray-800">
             {activeTab === 'HOME' && renderHome()}
             {activeTab === 'CURRENCY' && <CurrencyView />}
             {activeTab === 'TOOLS' && <ToolsView />}
             
             {/* AI FAB Button */}
             <button 
                onClick={() => setShowAI(true)}
                className="fixed bottom-24 right-4 bg-gradient-to-br from-indigo-500 to-purple-600 text-white p-4 rounded-full shadow-xl hover:scale-110 active:scale-95 transition-all z-40 flex items-center justify-center"
             >
                <Sparkles size={24} />
             </button>

             {showAI && <AIConciergeModal onClose={() => setShowAI(false)} />}

             <BottomNav activeTab={activeTab} onTabChange={handleTabChange} />
          </div>
        );
      };

      const root = createRoot(document.getElementById('root'));
      root.render(<App />);
    </script>
</body>
</html>